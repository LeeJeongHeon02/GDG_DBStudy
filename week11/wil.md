# Chapter 6. B-Tree Variants

이번 챕터에서는 B-Tree의 몇가지 변형된 버전을 배운다.
특히 DB에서 성능이나 동시성 측면에서 더 유리하도록 설계된 B-Tree들을 다룬다.
공통적으로 쓰기(write)작업을 더 안전하고 효율적으로 수행할 수 있도록 개선된 구조를 가지고 있다.
특히 복사-쓰기 방식은 기존 노드를 변경하는 대신 복사본을 생성해 변경사항을 적용해서 동시성 제어나 오류 복구 측면에서 이점을 가진다.

## Copy-on-Write (CoW)

- 노드를 직접 수정하는 것이 아닌, 복사본을 만들어 복사본 위에서 수정한다.
- 트리의 루트부터 변경이 일어나는 리프노드까지의 변경 경로상의 모든 노드를 복사해서 새로운 경로를 생성한다.
- 변경 후에는 루트 포인터를 새 루트로 교체하면서 전체 트리를 새로운 버전으로 전환한다.

<img width="607" height="248" alt="image" src="https://github.com/user-attachments/assets/8a2e362d-6019-48d1-bc71-b04ca3021187" />

**장점**
- 동시성 처리가 용이하다.
    - 읽기 작업은 기존 트리를 참조하므로 동기화 없이 병렬 처리가 가능하다.
- 오류 복구가 쉽다.
    - 쓰기 실패 발생 시 이전 트리는 그대로 존재한다.
- Versioning
    - 시간에 따라 트리 상태를 주적할 수 있다.
    **단점**
- 쓰기 성능
    - 매번 여러 노드를 복사해야 하므로 비용이 크다.
- 공간 사용 증가
    - 동일한 노드의 중복 복사로 인한 저장 공간의 낭비가 발생할 수 있다.

## Abstracting Node Updates

노드 업데이트 추상화를 통해 CoW기반 시스템에서 변경 관리(change management)를 단순화하는 방법을 알아보자.

- 모든 변경은 명령어 또는 변경 요청으로 표현된다.
- 이 명령어는 나중에 실행되거나 로그에 기록되어 적용될 수 있다.
- 예시
    - Insert(key, value)또는 Delete(key)같은 명령어가 있을 수 있다.
    - 각 명령어는 대상 노드를 지정하고 변경 사항을 포함한다.
    - 명령어는 별도의 작업 큐나 로그에 저장되며, 복사된 노드에 적용된다.
    **장점**
- 유연한 변경 적용 : 즉시 적용하지 않고 나중에 실행할 수 있다.
- 트랜잭션 시스템과 통합이 용이 : 명령어를 로그 형태로 관리하면 롤백이나 재시도도 간편하다.
- 단일 인터페이스 제공 : B-Tree 구현체는 내부적으로 다양한 명령어를 통일된 방식으로 처리 가능하다.
